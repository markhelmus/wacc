@(currentLocation: String, locations: List[String])

<div class="row">
    <div class="col-md-9">
        <form onsubmit="return false;">
            <input id="location" type="text" placeholder="Location" value="@currentLocation" />
            <input type="hidden" id="lat" />
            <input type="hidden" id="lng" />
            <button type="submit" id="liveData">buienradar Livedata</button>
        </form>
        <p id="error-output" />
    </div>
    @if(!locations.isEmpty) {
        <div class="col-md-3">
            <h3>Saved locations</h3>
            <ul class="list-group">
            @for(location <- locations) {
                <li class="list-group-item anchorLink" data-location="@location"><a href="@routes.Report.info(location)">@location</a></li>
            }
            </ul>
        </div>
    }
</div>

<div class="row">
    <div class="col-md-6">
        <h2>3 hour forecast</h2>
        <canvas id="chart3H" style="min-height: 250px;"></canvas>
    </div>
    <div class="col-md-6">
        <h2>24 hour forecast</h2>
        <canvas id="chart24H" style="min-height: 250px;"></canvas>
    </div>
</div>

<script src="@routes.Assets.versioned("javascripts/moment.min.js")" type="text/javascript"></script>
<script src="@routes.Assets.versioned("javascripts/chart.bundle.min.js")" type="text/javascript"></script>
<script src="@routes.Assets.versioned("javascripts/jquery.simple.websocket.js")" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function () {
        function loadLocationInformation(callback) {
            $.getJSON("http://maps.googleapis.com/maps/api/geocode/json?address=" + $("#location").val(), function (data) {
                if (data.results.length == 0) {
                    $('#error-output').text("Location not found");
                } else {
                    $("#lat").val(data.results[0].geometry.location.lat);
                    $("#lng").val(data.results[0].geometry.location.lng);

                    callback();
                }
            });
        }

        var chartSunlightOptions = {
            type: 'bar',
            data: {
                labels: [moment().toDate()],
                datasets: [{
                    label: 'Sun intensity',
                    data: [0],
                    backgroundColor: "rgba(250, 200, 0, 0.8)",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: "HH" // "dd HH"?
                            }
                        }
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            max: 100
                        }
                    }]
                }
            }
        };
        var chart3H = new Chart(document.getElementById("chart3H"), JSON.parse(JSON.stringify(chartSunlightOptions)));
        var chart24H = new Chart(document.getElementById("chart24H"), JSON.parse(JSON.stringify(chartSunlightOptions)));

        function updateChart(chart, timestampsString, values) {
            var timestamps = timestampsString.map(function (obj) {
                return moment(obj).toDate();
            });
            chart.data.labels = timestamps;
            chart.data.datasets[0].data = values;
            chart.update();
        }

        function liveData(lat, lon) {
            $.getJSON("http://graphdata.buienradar.nl/forecast/jsonsun/?lat=" + lat + "&lon=" + lon, function (data) {
                var timestamps = [];
                var values = [];
                $.each(data.forecasts, function (key, entry) {
                    timestamps.push(entry.datetime);
                    values.push(entry.value);
                });
                updateChart(chart3H, timestamps, values);
                if (timestamps.length == 0) {
                    $('#error-output').text("No sun forecast for the next 3 hours, might it be night?");
                }
            });
            $.getJSON("http://api.buienradar.nl/data/graphdata/1.0/sunforecast/24hours?lat=" + lat + "&lon=" + lon, function (data) {
                var timestamps = [];
                var values = [];
                $.each(data.forecasts, function (key, entry) {
                    timestamps.push(entry.datetime);
                    values.push(entry.value);
                });
                updateChart(chart24H, timestamps, values);
            });
        }

        function liveDataLocation() {
            $('#error-output').text("");

            loadLocationInformation(function () {
                liveData(data.results[0].geometry.location.lat, data.results[0].geometry.location.lng);
            });
        }

        //Register buienradar button
        $("#liveData").click(liveDataLocation);

        //Register location info buttons
        $(".anchorLink").click(function () {
            var location = $(this).data("location");
            $("#location").val(location);
            window.location.hash = location;
            loadLocationInformation();

            window.clearTimeout(reloadTimeout);
            requestWSUpdate();

            return false;
        });

        //Load location info from url
        function readCachedLocationInfo() {
            var hash = window.location.hash.substring(1);
            if(hash !== "") {
                $("#location").val(hash);
                loadLocationInformation();
            }
        }
        readCachedLocationInfo();

        var webSocket = $.simpleWebSocket({url: " ws://" + window.location.host + "/ws/weather"});
        // reconnected listening
        webSocket.listen(function (data) {
            console.log(" Received " + JSON.stringify(data, null, 2));
            // Update
            var timestamps3 = [];
            var values3 = [];
            $.each(data.hours3, function (key, entry) {
                timestamps3.push(entry.time);
                values3.push(entry.value);
            });
            updateChart(chart3H, timestamps3, values3);

            var timestamps24 = [];
            var values24 = [];
            $.each(data.hours24, function (key, entry) {
                timestamps24.push(entry.time);
                values24.push(entry.value);
            });
            updateChart(chart24H, timestamps24, values24);
        });

        var reloadTimeout;
        //Init websocket
        function requestWSUpdate() {
            var data = {
                location: $("#location").val(),
                lat: $("#lat").val(),
                lng: $("#lng").val(),
            };
            webSocket.send(data).done(function () {
                console.log(" Update requested");
            }).fail(function (e) {
                console.log(" Could not send message, " + e);
            });
            reloadTimeout = window.setTimeout(requestWSUpdate, 10000);
        }
        requestWSUpdate();
    })
</script>
