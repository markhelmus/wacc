# -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure(2) do |config|
  config.vm.box = "ubuntu/xenial64"
#  config.vm.box = "ubuntu/trusty64"

  config.vm.synced_folder ".", "/vagrant", disabled: false

  require 'ipaddr'
  
  $leader_ip = "192.168.10.10"
  $num_managers = 3
  $manager_start_ip = "192.168.10.11"
  $num_workers = 1
  $worker_start_ip = "192.168.10.100"
  $replicas = 5
  
  config.vm.define leader_name = "manager-01" do |leader|
    leader.vm.hostname = leader_name
    leader.vm.network "private_network", ip: $leader_ip
    leader.vm.network "forwarded_port", guest: 9000, host: 9000
    # vm pulls image from docker hub
    leader.vm.provision "docker" do |d|
      d.pull_images "timonback/wacc:latest"
    end
    leader.vm.provision "shell", args: [$leader_ip, $replicas], inline: <<-SHELL
      docker swarm init --advertise-addr $1
      mkdir /vagrant/docker-join-tokens
      docker swarm join-token worker --quiet > /vagrant/docker-join-tokens/worker
      docker swarm join-token manager --quiet > /vagrant/docker-join-tokens/manager
      docker service create --name helloworld -p 9000:9000 --replicas $2 timonback/wacc:latest
    SHELL
    leader.vm.provider "virtualbox" do |v|
      v.memory = 1024
    end
  end
  
  (2..$num_managers).each do |i|
    config.vm.define manager_name = "manager-%02d" % [i] do |config|
        config.vm.hostname = manager_name

        # just split out the ip

        ip = IPAddr.new($manager_start_ip)
        $manager_start_ip = ip.succ.to_s
        config.vm.network :private_network, ip: $manager_start_ip 
        config.vm.provision "shell", args: [$leader_ip], inline: <<-SHELL
          docker swarm join --token $(cat /vagrant/docker-join-tokens/manager) $1
        SHELL
    end
  end
  
  (1..$num_workers).each do |i|
    config.vm.define worker_name = "worker-%02d" % [i] do |config|
        config.vm.hostname = worker_name

        # just split out the ip

        ip = IPAddr.new($worker_start_ip)
        $worker_start_ip = ip.succ.to_s
        config.vm.network :private_network, ip: $worker_start_ip 
        config.vm.provision "shell", args: [$leader_ip], inline: <<-SHELL
          docker swarm join --token $(cat /vagrant/docker-join-tokens/worker) $1
        SHELL
    end
  end
  
  config.vm.provision "docker" do |d|
  end
  
  config.vm.provider "virtualbox" do |v|
    v.memory = 768
  end
  

  # install weave
  #config.vm.provision "shell", inline: <<-SHELL
  #  sudo curl -L git.io/weave -o /usr/local/bin/weave
  #  sudo chmod +x /usr/local/bin/weave
  #  weave launch
  #SHELL
end
