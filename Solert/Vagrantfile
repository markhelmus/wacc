# -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure(2) do |config|
#  config.vm.box = "ubuntu/xenial64"
  config.vm.box = "ubuntu/trusty64"

  config.vm.synced_folder ".", "/vagrant", disabled: false

  # vm with sbt to build the docker image
  config.vm.define "vm1" do |vm1|
    vm1.vm.network "private_network", ip: "192.168.10.14"
    vm1.vm.network "forwarded_port", guest: 9000, host: 9000

    vm1.vm.provision "shell", inline: <<-SHELL
      sudo add-apt-repository ppa:openjdk-r/ppa
      sudo apt-get update
      sudo apt-get install openjdk-8-jdk
      sudo update-alternatives --config java
#      sudo apt-get --yes install openjdk-8-jre-headless
      echo "deb https://dl.bintray.com/sbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
      sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 642AC823
      sudo apt-get update
      sudo apt-get --yes install sbt

	  cd /vagrant/docker/webserver
	  sbt docker:publishLocal
    SHELL

    # install docker and pull ubuntu image  
    vm1.vm.provision "docker" do |d|
      #d.build_image "/vagrant/docker/webserver",
      #  args: "-t image"
      d.run "webserver", image: "timonback/wacc:webserver",
        args: "-p 9000:9000"
    end
  end

  # vm pulls image from docker hub
  config.vm.define "vm2" do |vm2|
    vm2.vm.network "private_network", ip: "192.168.10.15"
    vm2.vm.network "forwarded_port", guest: 9000, host: 9001

    # install docker and pull ubuntu image
    vm2.vm.provision "docker" do |d|
      d.pull_images "timonback/wacc:latest"

      d.run "timonback/wacc",
        args: "-p 9000:9000"
    end
  end

  # static web server
  config.vm.define "vm3" do |vm3|
    vm3.vm.network "private_network", ip: "192.168.10.16"
    vm3.vm.network "forwarded_port", guest: 80, host: 8999

    # install docker and pull ubuntu image
    vm3.vm.provision "docker" do |d|
      d.build_image "/vagrant/docker/nginx",
        args: "-t image"

      d.run "image",
        args: "-p 80:80"
    end
  end
  
  config.vm.provider "virtualbox" do |v|
    v.memory = 1536
  end
  
  config.vm.provision "docker" do |d|
  end

  # install weave
  #config.vm.provision "shell", inline: <<-SHELL
  #  sudo curl -L git.io/weave -o /usr/local/bin/weave
  #  sudo chmod +x /usr/local/bin/weave
  #  weave launch
  #SHELL
end
